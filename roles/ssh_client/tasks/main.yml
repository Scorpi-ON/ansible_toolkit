---
- name: Block
  when: ssh_client_copy_local | bool
  block:
    - name: Ensure ssh_client_user and ssh_client_home are set
      ansible.builtin.assert:
        that:
          - ssh_client_user | length > 0
          - ssh_client_home | length > 0
        fail_msg: ssh_client_user and ssh_client_home are required

    - name: Check local SSH directory
      ansible.builtin.stat:
        path: "{{ ssh_client_local_ssh_dir }}"
      delegate_to: localhost
      changed_when: false
      register: ssh_client_local_ssh_stat

    - name: Ensure local SSH directory exists
      ansible.builtin.assert:
        that:
          - ssh_client_local_ssh_stat.stat.exists
          - ssh_client_local_ssh_stat.stat.isdir
        fail_msg: "Local SSH directory not found: {{ ssh_client_local_ssh_dir }}"

    - name: Ensure target SSH directory exists
      ansible.builtin.file:
        path: "{{ ssh_client_home }}/.ssh"
        state: directory
        owner: "{{ ssh_client_user }}"
        group: "{{ ssh_client_user }}"
        mode: "0700"

    - name: Find local SSH files (top-level only)
      ansible.builtin.find:
        paths: "{{ ssh_client_local_ssh_dir }}"
        file_type: file
        recurse: false
        follow: false
      delegate_to: localhost
      register: ssh_client_local_files

    - name: Copy local SSH files to target
      ansible.builtin.copy:
        src: "{{ item.path }}"
        dest: "{{ ssh_client_home }}/.ssh/{{ item.path | basename }}"
        owner: "{{ ssh_client_user }}"
        group: "{{ ssh_client_user }}"
        mode: "{{ item.mode }}"
      loop: "{{ ssh_client_local_files.files }}"
